<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WormGPT - @ban59</title>
    <style>
        :root { --bg: #050505; --txt: #ffffff; --primary: #8b0000; --glow: #ff3e3e; --bot-bg: #0f0f0f; --border: #222; }
        body.light { --bg: #f5f5f5; --txt: #222; --primary: #cc0000; --glow: #ff0000; --bot-bg: #ffffff; --border: #ddd; }
        body { background: var(--bg); color: var(--txt); font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; transition: 0.3s; }
        #particles-js { position: absolute; width: 100%; height: 100%; z-index: -1; pointer-events: none; }
        .header { padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); z-index: 10; }
        .logo { color: var(--glow); font-weight: bold; font-size: 1.3rem; text-shadow: 0 0 10px var(--glow); }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; z-index: 5; scroll-behavior: smooth; }
        .msg { max-width: 85%; padding: 15px; border-radius: 12px; font-size: 0.95rem; line-height: 1.6; position: relative; animation: fadeIn 0.3s; }
        .user { align-self: flex-start; background: linear-gradient(to right, #600, #900); color: white; border: 1px solid var(--glow); }
        .bot { align-self: flex-end; background: var(--bot-bg); border: 1px solid var(--border); }
        .tools { display: flex; gap: 12px; margin-top: 10px; border-top: 1px solid #333; padding-top: 8px; }
        .tool-btn { color: #888; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: 0.2s; }
        .tool-btn:hover { color: var(--glow); }
        .preview-area { display: none; padding: 10px; background: rgba(139,0,0,0.2); border-top: 2px solid var(--primary); text-align: center; position: relative; }
        .preview-img { max-height: 100px; border-radius: 8px; border: 1px solid var(--glow); }
        .input-area { padding: 15px; background: var(--bg); z-index: 10; }
        .input-box { width: 100%; max-width: 700px; background: var(--bot-bg); border: 2px solid var(--primary); border-radius: 50px; padding: 5px 15px; display: flex; align-items: center; margin: 0 auto; box-shadow: 0 0 15px rgba(139, 0, 0, 0.3); }
        input { flex: 1; background: transparent; border: none; color: var(--txt); padding: 12px; outline: none; text-align: right; }
        .btn { width: 45px; height: 45px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; background: var(--primary); margin: 0 4px; }
    </style>
</head>
<body>
    <div id="particles-js"></div>
    <div class="header">
        <div style="display:flex; gap:8px;">
            <button class="btn" style="width:35px; height:35px; background:#222;" onclick="toggleTheme()" id="tBtn">â˜€ï¸</button>
            <button class="btn" style="width:35px; height:35px; background:#222;" onclick="clearChat()">ğŸ—‘ï¸</button>
        </div>
        <div class="logo">WORMGPT</div>
        <div style="font-size: 0.7rem; color: var(--glow);">@ban59</div>
    </div>
    <div id="chat"></div>
    <div id="previewArea" class="preview-area">
        <button onclick="cancelImage()" style="position:absolute; left:20px; background:red; color:white; border:none; border-radius:3px; cursor:pointer; font-size:10px;">Ø¥Ù„ØºØ§Ø¡</button>
        <img id="imagePreview" class="preview-img">
    </div>
    <div id="status" style="display:none; text-align:center; color:var(--glow); font-size:0.8rem; padding:10px;">WormGPT ÙŠØ¬Ù‡Ø² Ø§Ù„Ø±Ø¯...</div>
    <div class="input-area">
        <div class="input-box">
            <button class="btn" onclick="send()">â¤</button>
            <input type="text" id="userInput" placeholder="Ø§Ø·Ø±Ø­ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..." onkeypress="if(event.key==='Enter') send()">
            <input type="file" id="fInput" style="display:none" accept="image/*" onchange="previewImage(this)">
            <button class="btn" onclick="document.getElementById('fInput').click()">ğŸ–¼ï¸</button>
            <button class="btn" id="mBtn" onclick="startVoice()">ğŸ¤</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>
    <script>
        particlesJS('particles-js', { "particles": { "number": { "value": 60 }, "color": { "value": "#ff0000" }, "move": { "speed": 2 } } });
        let chatHistory = JSON.parse(localStorage.getItem('worm_v18')) || [];
        let selectedImageData = null;

        function toggleTheme() {
            document.body.classList.toggle('light');
            localStorage.setItem('theme', document.body.classList.contains('light') ? 'light' : 'dark');
            document.getElementById('tBtn').innerText = document.body.classList.contains('light') ? "ğŸŒ™" : "â˜€ï¸";
        }
        if(localStorage.getItem('theme') === 'light') toggleTheme();

        function render() {
            const chatDiv = document.getElementById('chat');
            chatDiv.innerHTML = chatHistory.length === 0 ? '<div class="msg bot">Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙŠØ§ Ø¶Ù„Ø¹! Ø£Ù†Ø§ WormGPT Ø§Ù„Ù…Ø·ÙˆØ± Ù…Ù† Ù‚Ø¨Ù„ @ban59. Ø´Ù…Ø­ØªØ§Ø¬ Ø§Ù„ÙŠÙˆÙ…ØŸ</div>' : "";
            chatHistory.forEach(m => {
                const div = document.createElement('div');
                div.className = `msg ${m.role}`;
                let content = m.content.replace(/HackerExos/gi, "@ban59").replace(/ØªÙ†Ø¨ÙŠÙ‡ Ø£Ù…Ù†ÙŠ/g, "Ù†Ø¸Ø§Ù… WormGPT");
                div.innerHTML = `${m.img ? `<img src="${m.img}" style="max-width:100%; border-radius:8px; margin-bottom:10px;">` : ""}<div>${content}</div>`;
                if(m.role === 'bot') {
                    div.innerHTML += `
                    <div class="tools">
                        <div class="tool-btn" onclick="speak('${content.replace(/'/g, "\\'")}')">ğŸ”Š Ø§Ø³ØªÙ…Ø¹</div>
                        <div class="tool-btn" onclick="copy('${content.replace(/'/g, "\\'")}')">ğŸ“‹ Ù†Ø³Ø®</div>
                    </div>`;
                }
                chatDiv.appendChild(div);
            });
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        function speak(text) {
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'ar-SA';
            utterance.rate = 0.9; // Ø³Ø±Ø¹Ø© Ø§Ù„ÙƒÙ„Ø§Ù…
            window.speechSynthesis.speak(utterance);
        }

        function copy(t) {
            navigator.clipboard.writeText(t);
            alert("ØªÙ… Ø§Ù„Ù†Ø³Ø® Ø¨Ù†Ø¬Ø§Ø­!");
        }

        function previewImage(input) {
            const file = input.files[0];
            if(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedImageData = e.target.result;
                    document.getElementById('imagePreview').src = selectedImageData;
                    document.getElementById('previewArea').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }
        function cancelImage() { selectedImageData = null; document.getElementById('previewArea').style.display = 'none'; }

        async function send() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            if(!text && !selectedImageData) return;

            chatHistory.push({role: 'user', content: text || "ØªØ­Ù„ÙŠÙ„ ØµÙˆØ±Ø©", img: selectedImageData});
            const img = selectedImageData; cancelImage(); input.value = ""; render();
            document.getElementById('status').style.display = "block";

            try {
                const res = await fetch("https://abojjjpsjdgcibfceugk.supabase.co/functions/v1/chat", {
                    method: "POST",
                    headers: {"Content-Type": "application/json"},
                    body: JSON.stringify({
                        "api_key": "worm_e7bCq1CWQOd7orpXQmiDPQmsLYqzhiRO",
                        "message": text,
                        "session_id": "Worm_V18_Voice"
                    })
                });
                const data = await res.json();
                chatHistory.push({role: 'bot', content: data.response || "ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø·Ù„Ø¨."});
            } catch { chatHistory.push({role: 'bot', content: "Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¨Ø§Ù„Ø´Ø¨ÙƒØ©."}); }
            
            localStorage.setItem('worm_v18', JSON.stringify(chatHistory));
            document.getElementById('status').style.display = "none";
            render();
        }

        function startVoice() {
            const rec = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            rec.lang = 'ar-SA';
            rec.onstart = () => document.getElementById('mBtn').style.background = "#00ff00";
            rec.onend = () => document.getElementById('mBtn').style.background = "#8b0000";
            rec.onresult = (e) => { document.getElementById('userInput').value = e.results[0][0].transcript; send(); };
            rec.start();
        }

        function clearChat() { if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø³Ø­ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©ØŸ")) { chatHistory=[]; localStorage.removeItem('worm_v18'); render(); } }
        render();
    </script>
</body>
</html>
